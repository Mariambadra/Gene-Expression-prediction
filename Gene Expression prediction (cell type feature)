{
 "cells": [
  {
   "cell_type": "code",
   "execution_count": 1,
   "id": "5fa64a08",
   "metadata": {
    "_cell_guid": "b1076dfc-b9ad-4769-8c92-a6c4dae69d19",
    "_uuid": "8f2839f25d086af736a60e9eeb907d3b93b6e0e5",
    "execution": {
     "iopub.execute_input": "2026-01-13T11:19:24.879911Z",
     "iopub.status.busy": "2026-01-13T11:19:24.879624Z",
     "iopub.status.idle": "2026-01-13T11:19:25.595608Z",
     "shell.execute_reply": "2026-01-13T11:19:25.594811Z"
    },
    "papermill": {
     "duration": 0.723578,
     "end_time": "2026-01-13T11:19:25.597225",
     "exception": false,
     "start_time": "2026-01-13T11:19:24.873647",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "/kaggle/input/gene-expression-prediction-cs1850-final/sample_submission.csv\n",
      "/kaggle/input/gene-expression-prediction-cs1850-final/train.npz\n",
      "/kaggle/input/gene-expression-prediction-cs1850-final/info.py\n",
      "/kaggle/input/gene-expression-prediction-cs1850-final/eval.npz\n",
      "/kaggle/input/gene-expression-prediction-cs1850-final/seq_data.csv\n"
     ]
    }
   ],
   "source": [
    "# This Python 3 environment comes with many helpful analytics libraries installed\n",
    "# It is defined by the kaggle/python Docker image: https://github.com/kaggle/docker-python\n",
    "# For example, here's several helpful packages to load\n",
    "\n",
    "import numpy as np # linear algebra\n",
    "import pandas as pd # data processing, CSV file I/O (e.g. pd.read_csv)\n",
    "\n",
    "# Input data files are available in the read-only \"../input/\" directory\n",
    "# For example, running this (by clicking run or pressing Shift+Enter) will list all files under the input directory\n",
    "\n",
    "import os\n",
    "for dirname, _, filenames in os.walk('/kaggle/input'):\n",
    "    for filename in filenames:\n",
    "        print(os.path.join(dirname, filename))\n",
    "\n",
    "# You can write up to 20GB to the current directory (/kaggle/working/) that gets preserved as output when you create a version using \"Save & Run All\" \n",
    "# You can also write temporary files to /kaggle/temp/, but they won't be saved outside of the current session"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "1000c5ec",
   "metadata": {
    "papermill": {
     "duration": 0.003953,
     "end_time": "2026-01-13T11:19:25.605499",
     "exception": false,
     "start_time": "2026-01-13T11:19:25.601546",
     "status": "completed"
    },
    "tags": []
   },
   "source": [
    "\n",
    "- In the first notebook ([Gene Expression prediction (Baseline + 1D CNN)](http://www.kaggle.com/code/mariamali12/gene-expression-prediction-baseline-1d-cnn)), we built a 1D CNN model to predict the gene expression using histone markers as a feature.\n",
    "  \n",
    "- In this notebook, we will extend our work and try to improve our model performance using an additional feature (cell type)\n",
    "\n",
    "- What we are trying to answer in this notebook is could adding cell type info improve the model performance? \n",
    "  "
   ]
  },
  {
   "cell_type": "markdown",
   "id": "25907693",
   "metadata": {
    "papermill": {
     "duration": 0.003693,
     "end_time": "2026-01-13T11:19:25.612999",
     "exception": false,
     "start_time": "2026-01-13T11:19:25.609306",
     "status": "completed"
    },
    "tags": []
   },
   "source": [
    "# Libraries Importing "
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 2,
   "id": "089a5f52",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2026-01-13T11:19:25.622138Z",
     "iopub.status.busy": "2026-01-13T11:19:25.621460Z",
     "iopub.status.idle": "2026-01-13T11:19:40.269044Z",
     "shell.execute_reply": "2026-01-13T11:19:40.268226Z"
    },
    "papermill": {
     "duration": 14.653851,
     "end_time": "2026-01-13T11:19:40.270760",
     "exception": false,
     "start_time": "2026-01-13T11:19:25.616909",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "2026-01-13 11:19:28.531414: E external/local_xla/xla/stream_executor/cuda/cuda_fft.cc:467] Unable to register cuFFT factory: Attempting to register factory for plugin cuFFT when one has already been registered\n",
      "WARNING: All log messages before absl::InitializeLog() is called are written to STDERR\n",
      "E0000 00:00:1768303168.716371      24 cuda_dnn.cc:8579] Unable to register cuDNN factory: Attempting to register factory for plugin cuDNN when one has already been registered\n",
      "E0000 00:00:1768303168.772518      24 cuda_blas.cc:1407] Unable to register cuBLAS factory: Attempting to register factory for plugin cuBLAS when one has already been registered\n",
      "W0000 00:00:1768303169.209289      24 computation_placer.cc:177] computation placer already registered. Please check linkage and avoid linking the same target more than once.\n",
      "W0000 00:00:1768303169.209336      24 computation_placer.cc:177] computation placer already registered. Please check linkage and avoid linking the same target more than once.\n",
      "W0000 00:00:1768303169.209339      24 computation_placer.cc:177] computation placer already registered. Please check linkage and avoid linking the same target more than once.\n",
      "W0000 00:00:1768303169.209341      24 computation_placer.cc:177] computation placer already registered. Please check linkage and avoid linking the same target more than once.\n"
     ]
    }
   ],
   "source": [
    "import random\n",
    "import matplotlib.pyplot as plt\n",
    "from sklearn.model_selection import train_test_split\n",
    "from sklearn.linear_model import Ridge\n",
    "from sklearn.metrics import mean_squared_error, r2_score\n",
    "from sklearn.preprocessing import StandardScaler\n",
    "import tensorflow as tf\n",
    "from tensorflow.keras.models import Model\n",
    "from tensorflow.keras.layers import Input, Embedding, Concatenate, Conv1D, MaxPooling1D, Flatten, Dense, Dropout, GlobalAveragePooling1D, BatchNormalization\n",
    "from tensorflow.keras.callbacks import EarlyStopping\n",
    "from tensorflow.keras.regularizers import l2"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 3,
   "id": "71523914",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2026-01-13T11:19:40.280287Z",
     "iopub.status.busy": "2026-01-13T11:19:40.279808Z",
     "iopub.status.idle": "2026-01-13T11:19:40.284134Z",
     "shell.execute_reply": "2026-01-13T11:19:40.283463Z"
    },
    "papermill": {
     "duration": 0.010493,
     "end_time": "2026-01-13T11:19:40.285530",
     "exception": false,
     "start_time": "2026-01-13T11:19:40.275037",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [],
   "source": [
    "#Set Random seeds\n",
    "SEED = 42\n",
    "\n",
    "os.environ[\"PYTHONHASHSEED\"] = str(SEED)\n",
    "random.seed(SEED)\n",
    "np.random.seed(SEED)\n",
    "tf.random.set_seed(SEED)"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "3a9c7455",
   "metadata": {
    "papermill": {
     "duration": 0.003905,
     "end_time": "2026-01-13T11:19:40.293457",
     "exception": false,
     "start_time": "2026-01-13T11:19:40.289552",
     "status": "completed"
    },
    "tags": []
   },
   "source": [
    "# Exploring Datasets"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 4,
   "id": "43b53464",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2026-01-13T11:19:40.303682Z",
     "iopub.status.busy": "2026-01-13T11:19:40.303102Z",
     "iopub.status.idle": "2026-01-13T11:19:40.320275Z",
     "shell.execute_reply": "2026-01-13T11:19:40.319720Z"
    },
    "papermill": {
     "duration": 0.023289,
     "end_time": "2026-01-13T11:19:40.321587",
     "exception": false,
     "start_time": "2026-01-13T11:19:40.298298",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [
    {
     "data": {
      "text/plain": [
       "50"
      ]
     },
     "execution_count": 4,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "#Load training dataset\n",
    "train_data = np.load('/kaggle/input/gene-expression-prediction-cs1850-final/train.npz')\n",
    "len(train_data.files)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 5,
   "id": "fae6c1e6",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2026-01-13T11:19:40.330990Z",
     "iopub.status.busy": "2026-01-13T11:19:40.330510Z",
     "iopub.status.idle": "2026-01-13T11:19:40.342996Z",
     "shell.execute_reply": "2026-01-13T11:19:40.342414Z"
    },
    "papermill": {
     "duration": 0.018507,
     "end_time": "2026-01-13T11:19:40.344230",
     "exception": false,
     "start_time": "2026-01-13T11:19:40.325723",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [
    {
     "data": {
      "text/plain": [
       "56"
      ]
     },
     "execution_count": 5,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "#Load testing dataset\n",
    "eval_data = np.load('/kaggle/input/gene-expression-prediction-cs1850-final/eval.npz')\n",
    "len(eval_data.files)\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 6,
   "id": "0ccb4477",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2026-01-13T11:19:40.353581Z",
     "iopub.status.busy": "2026-01-13T11:19:40.353342Z",
     "iopub.status.idle": "2026-01-13T11:19:40.530234Z",
     "shell.execute_reply": "2026-01-13T11:19:40.529569Z"
    },
    "papermill": {
     "duration": 0.1833,
     "end_time": "2026-01-13T11:19:40.531717",
     "exception": false,
     "start_time": "2026-01-13T11:19:40.348417",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [
    {
     "data": {
      "text/plain": [
       "16000"
      ]
     },
     "execution_count": 6,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "len(train_data['E065'][:,:,6])"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "a6c4ca46",
   "metadata": {
    "papermill": {
     "duration": 0.004185,
     "end_time": "2026-01-13T11:19:40.540291",
     "exception": false,
     "start_time": "2026-01-13T11:19:40.536106",
     "status": "completed"
    },
    "tags": []
   },
   "source": [
    "### Training dataset structure:\n",
    "- **First column:** gene ID\n",
    "- **Second-sixth columns:** histone modification measurements\n",
    "- **Seventh column:** gene expression\n",
    "\n",
    "### Each cell type contains:\n",
    "- 16000 genes\n",
    "- 100 bins\n",
    "- 5 histone markers\n",
    "- Each gene–cell pair is treated as an independent training example."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 7,
   "id": "82e8001b",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2026-01-13T11:19:40.549887Z",
     "iopub.status.busy": "2026-01-13T11:19:40.549622Z",
     "iopub.status.idle": "2026-01-13T11:19:40.554059Z",
     "shell.execute_reply": "2026-01-13T11:19:40.553495Z"
    },
    "papermill": {
     "duration": 0.010811,
     "end_time": "2026-01-13T11:19:40.555323",
     "exception": false,
     "start_time": "2026-01-13T11:19:40.544512",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [],
   "source": [
    "# Keys to npzfile of train & eval\n",
    "train_cells = ['E065', 'E004', 'E066', 'E005', 'E012', 'E027', 'E053', 'E013', 'E028', 'E061', 'E109', 'E120',\n",
    "               'E062', 'E037', 'E038', 'E024', 'E105', 'E011', 'E106', 'E082', 'E097', 'E116', 'E098', 'E058', \n",
    "'E117', 'E059', 'E070', 'E118', 'E085', 'E104', 'E119', 'E006', 'E127', 'E047', 'E094', 'E007', 'E054', 'E128',\n",
    "               'E095', 'E055', 'E114', 'E100', 'E056', 'E016', 'E122', 'E057', 'E123', 'E079', 'E003', 'E050']\n",
    "Tcell_to_id = {cell: idx for idx, cell in enumerate(train_cells)}\n",
    "Tnum_cells = len(Tcell_to_id)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 8,
   "id": "2ef54f8e",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2026-01-13T11:19:40.564543Z",
     "iopub.status.busy": "2026-01-13T11:19:40.564323Z",
     "iopub.status.idle": "2026-01-13T11:19:40.569020Z",
     "shell.execute_reply": "2026-01-13T11:19:40.568378Z"
    },
    "papermill": {
     "duration": 0.010928,
     "end_time": "2026-01-13T11:19:40.570360",
     "exception": false,
     "start_time": "2026-01-13T11:19:40.559432",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [],
   "source": [
    "eval_cells = ['E065', 'E004', 'E066', 'E005', 'E012', 'E027', 'E053', 'E013', 'E028', 'E061', 'E109', 'E120', \n",
    "              'E062', 'E037', 'E038', 'E024', 'E071', 'E105', 'E087', 'E011', 'E106', 'E096', 'E082', 'E097', \n",
    "'E116', 'E098', 'E058', 'E117', 'E084', 'E059', 'E070', 'E118', 'E085', 'E104', 'E119', 'E006', 'E112', 'E127',\n",
    "              'E047', 'E094', 'E007', 'E054', 'E113', 'E128', 'E095', 'E055', 'E114', 'E100', 'E056', 'E016', 'E122',\n",
    "              'E057', 'E123', 'E079', 'E003', 'E050']\n",
    "Ecell_to_id = {cell: idx for idx, cell in enumerate(eval_cells)}\n",
    "Enum_cells = len(Ecell_to_id)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 9,
   "id": "01354100",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2026-01-13T11:19:40.579359Z",
     "iopub.status.busy": "2026-01-13T11:19:40.579134Z",
     "iopub.status.idle": "2026-01-13T11:19:49.993626Z",
     "shell.execute_reply": "2026-01-13T11:19:49.993055Z"
    },
    "papermill": {
     "duration": 9.420989,
     "end_time": "2026-01-13T11:19:49.995393",
     "exception": false,
     "start_time": "2026-01-13T11:19:40.574404",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [],
   "source": [
    "# Combine Train Data to use information from all cells\n",
    "train_inputs = [] # histone mark data (X)\n",
    "train_outputs = [] # expression value (y)\n",
    "Tcell_id_list = []\n",
    "for cell in train_cells:\n",
    "    cell_data = train_data[cell]\n",
    "    hm_data = cell_data[:,:,1:6]\n",
    "    exp_values = cell_data[:,0,6]\n",
    "    cell_ids = np.full(len(exp_values), Tcell_to_id[cell])\n",
    "    train_inputs.append(hm_data)\n",
    "    train_outputs.append(exp_values)\n",
    "    Tcell_id_list.append(cell_ids)\n",
    "\n",
    "train_inputs = np.concatenate(train_inputs, axis=0)\n",
    "train_outputs = np.concatenate(train_outputs, axis=0)\n",
    "Tcell_ids = np.concatenate(Tcell_id_list, axis=0)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 10,
   "id": "98925313",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2026-01-13T11:19:50.005171Z",
     "iopub.status.busy": "2026-01-13T11:19:50.004917Z",
     "iopub.status.idle": "2026-01-13T11:19:50.008911Z",
     "shell.execute_reply": "2026-01-13T11:19:50.008158Z"
    },
    "papermill": {
     "duration": 0.010373,
     "end_time": "2026-01-13T11:19:50.010326",
     "exception": false,
     "start_time": "2026-01-13T11:19:49.999953",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "(800000, 100, 5)\n",
      "(800000,)\n",
      "(800000,)\n"
     ]
    }
   ],
   "source": [
    "print(train_inputs.shape)\n",
    "print(train_outputs.shape)\n",
    "print(Tcell_ids.shape)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 11,
   "id": "8c2c57eb",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2026-01-13T11:19:50.023569Z",
     "iopub.status.busy": "2026-01-13T11:19:50.023314Z",
     "iopub.status.idle": "2026-01-13T11:19:52.225477Z",
     "shell.execute_reply": "2026-01-13T11:19:52.224886Z"
    },
    "papermill": {
     "duration": 2.209425,
     "end_time": "2026-01-13T11:19:52.227090",
     "exception": false,
     "start_time": "2026-01-13T11:19:50.017665",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [],
   "source": [
    "# Prepare Eval inputs in a similar way\n",
    "eval_X = []\n",
    "eval_cell_ids = []\n",
    "eval_ids = []\n",
    "\n",
    "for cell in eval_data.files:\n",
    "    cell_array = eval_data[cell]\n",
    "    \n",
    "    X_cell = cell_array[:, :, 1:6]\n",
    "    genes = cell_array[:, 0, 0].astype(int)\n",
    "    \n",
    "    eval_X.append(X_cell)\n",
    "    eval_cell_ids.append(\n",
    "        np.full(len(genes), Ecell_to_id[cell])\n",
    "    )\n",
    "    \n",
    "    eval_ids.extend([f\"{cell}_{g}\" for g in genes])\n",
    "\n",
    "eval_X = np.concatenate(eval_X)\n",
    "eval_cell_ids = np.concatenate(eval_cell_ids)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 12,
   "id": "b3397817",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2026-01-13T11:19:52.237212Z",
     "iopub.status.busy": "2026-01-13T11:19:52.236960Z",
     "iopub.status.idle": "2026-01-13T11:19:52.240614Z",
     "shell.execute_reply": "2026-01-13T11:19:52.239955Z"
    },
    "papermill": {
     "duration": 0.010234,
     "end_time": "2026-01-13T11:19:52.242044",
     "exception": false,
     "start_time": "2026-01-13T11:19:52.231810",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "(177032, 100, 5)\n"
     ]
    }
   ],
   "source": [
    "print(eval_X.shape)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 13,
   "id": "491181f1",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2026-01-13T11:19:52.251410Z",
     "iopub.status.busy": "2026-01-13T11:19:52.251188Z",
     "iopub.status.idle": "2026-01-13T11:19:52.259733Z",
     "shell.execute_reply": "2026-01-13T11:19:52.259008Z"
    },
    "papermill": {
     "duration": 0.014682,
     "end_time": "2026-01-13T11:19:52.260994",
     "exception": false,
     "start_time": "2026-01-13T11:19:52.246312",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Mean: -0.27236924\n",
      "Std: 1.8670437\n",
      "Min: -5.204512\n",
      "Max: 10.710043\n"
     ]
    }
   ],
   "source": [
    "#explore the expression values statistically\n",
    "\n",
    "print(\"Mean:\", np.mean(train_outputs))\n",
    "print(\"Std:\", np.std(train_outputs))\n",
    "print(\"Min:\", np.min(train_outputs))\n",
    "print(\"Max:\", np.max(train_outputs))"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "d06a2bb9",
   "metadata": {
    "papermill": {
     "duration": 0.004176,
     "end_time": "2026-01-13T11:19:52.269421",
     "exception": false,
     "start_time": "2026-01-13T11:19:52.265245",
     "status": "completed"
    },
    "tags": []
   },
   "source": [
    "# Model Building"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "442fb034",
   "metadata": {
    "papermill": {
     "duration": 0.004196,
     "end_time": "2026-01-13T11:19:52.277722",
     "exception": false,
     "start_time": "2026-01-13T11:19:52.273526",
     "status": "completed"
    },
    "tags": []
   },
   "source": [
    "# Build 1D CNN model"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 14,
   "id": "4db12bd1",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2026-01-13T11:19:52.287054Z",
     "iopub.status.busy": "2026-01-13T11:19:52.286824Z",
     "iopub.status.idle": "2026-01-13T11:19:52.289792Z",
     "shell.execute_reply": "2026-01-13T11:19:52.289254Z"
    },
    "papermill": {
     "duration": 0.009143,
     "end_time": "2026-01-13T11:19:52.291030",
     "exception": false,
     "start_time": "2026-01-13T11:19:52.281887",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [],
   "source": [
    "X = train_inputs\n",
    "y = train_outputs"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 15,
   "id": "1f4c6e47",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2026-01-13T11:19:52.301322Z",
     "iopub.status.busy": "2026-01-13T11:19:52.301022Z",
     "iopub.status.idle": "2026-01-13T11:19:52.317474Z",
     "shell.execute_reply": "2026-01-13T11:19:52.316936Z"
    },
    "papermill": {
     "duration": 0.023607,
     "end_time": "2026-01-13T11:19:52.318875",
     "exception": false,
     "start_time": "2026-01-13T11:19:52.295268",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [],
   "source": [
    "#scaling the target\n",
    "scaler = StandardScaler()\n",
    "y_scaled = scaler.fit_transform(y.reshape(-1, 1)).flatten()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 16,
   "id": "32665e8d",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2026-01-13T11:19:52.328254Z",
     "iopub.status.busy": "2026-01-13T11:19:52.328026Z",
     "iopub.status.idle": "2026-01-13T11:19:52.332168Z",
     "shell.execute_reply": "2026-01-13T11:19:52.331630Z"
    },
    "papermill": {
     "duration": 0.010293,
     "end_time": "2026-01-13T11:19:52.333403",
     "exception": false,
     "start_time": "2026-01-13T11:19:52.323110",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [
    {
     "data": {
      "text/plain": [
       "numpy.ndarray"
      ]
     },
     "execution_count": 16,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "type(y_scaled)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 17,
   "id": "12bb7ae9",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2026-01-13T11:19:52.342942Z",
     "iopub.status.busy": "2026-01-13T11:19:52.342703Z",
     "iopub.status.idle": "2026-01-13T11:19:52.916331Z",
     "shell.execute_reply": "2026-01-13T11:19:52.915671Z"
    },
    "papermill": {
     "duration": 0.580229,
     "end_time": "2026-01-13T11:19:52.917956",
     "exception": false,
     "start_time": "2026-01-13T11:19:52.337727",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [],
   "source": [
    "#train/validate split\n",
    "X_train, X_val, y_train, y_val, cell_train, cell_val= train_test_split(X, y_scaled, Tcell_ids, test_size=0.2, random_state=SEED)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 18,
   "id": "e0f4fd37",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2026-01-13T11:19:52.928114Z",
     "iopub.status.busy": "2026-01-13T11:19:52.927866Z",
     "iopub.status.idle": "2026-01-13T11:19:55.102202Z",
     "shell.execute_reply": "2026-01-13T11:19:55.101423Z"
    },
    "papermill": {
     "duration": 2.181325,
     "end_time": "2026-01-13T11:19:55.103826",
     "exception": false,
     "start_time": "2026-01-13T11:19:52.922501",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "I0000 00:00:1768303193.750535      24 gpu_device.cc:2019] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 13942 MB memory:  -> device: 0, name: Tesla T4, pci bus id: 0000:00:04.0, compute capability: 7.5\n",
      "I0000 00:00:1768303193.754392      24 gpu_device.cc:2019] Created device /job:localhost/replica:0/task:0/device:GPU:1 with 13942 MB memory:  -> device: 1, name: Tesla T4, pci bus id: 0000:00:05.0, compute capability: 7.5\n"
     ]
    }
   ],
   "source": [
    "#Functional CNN\n",
    "\n",
    "signal_input = Input(shape=(100, 5), name=\"histone_input\")\n",
    "\n",
    "x = Conv1D(32, kernel_size=5, padding=\"same\", activation=\"relu\")(signal_input)\n",
    "x = Conv1D(64, kernel_size=5, padding=\"same\", activation=\"relu\")(x)\n",
    "x = MaxPooling1D(pool_size=2)(x)\n",
    "\n",
    "x = Conv1D(128, kernel_size=7, padding=\"same\", activation=\"relu\")(x)\n",
    "x = GlobalAveragePooling1D()(x)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 19,
   "id": "602dc45c",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2026-01-13T11:19:55.114534Z",
     "iopub.status.busy": "2026-01-13T11:19:55.114103Z",
     "iopub.status.idle": "2026-01-13T11:19:55.124282Z",
     "shell.execute_reply": "2026-01-13T11:19:55.123623Z"
    },
    "papermill": {
     "duration": 0.01712,
     "end_time": "2026-01-13T11:19:55.125598",
     "exception": false,
     "start_time": "2026-01-13T11:19:55.108478",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [],
   "source": [
    "#encoding cell-type code using embedding\n",
    "cell_input = Input(shape=(1,), name=\"cell_id\")\n",
    "\n",
    "cell_embed = Embedding(\n",
    "    input_dim=Enum_cells,\n",
    "    output_dim=32,\n",
    "    name=\"cell_embedding\"\n",
    ")(cell_input)\n",
    "\n",
    "cell_embed = Flatten()(cell_embed)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 20,
   "id": "b3045a4c",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2026-01-13T11:19:55.135653Z",
     "iopub.status.busy": "2026-01-13T11:19:55.135133Z",
     "iopub.status.idle": "2026-01-13T11:19:55.153303Z",
     "shell.execute_reply": "2026-01-13T11:19:55.152805Z"
    },
    "papermill": {
     "duration": 0.024587,
     "end_time": "2026-01-13T11:19:55.154665",
     "exception": false,
     "start_time": "2026-01-13T11:19:55.130078",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [],
   "source": [
    "# combine the 2 models\n",
    "\n",
    "combined = Concatenate()([x, cell_embed])\n",
    "\n",
    "combined = Dense(256, activation=\"relu\")(combined)\n",
    "#combined = Dropout(0.3)(combined)\n",
    "\n",
    "output = Dense(1, activation=\"linear\")(combined)\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 21,
   "id": "067ea9b5",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2026-01-13T11:19:55.164270Z",
     "iopub.status.busy": "2026-01-13T11:19:55.164028Z",
     "iopub.status.idle": "2026-01-13T11:19:55.193219Z",
     "shell.execute_reply": "2026-01-13T11:19:55.192489Z"
    },
    "papermill": {
     "duration": 0.03566,
     "end_time": "2026-01-13T11:19:55.194625",
     "exception": false,
     "start_time": "2026-01-13T11:19:55.158965",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [
    {
     "data": {
      "text/html": [
       "<pre style=\"white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace\"><span style=\"font-weight: bold\">Model: \"functional\"</span>\n",
       "</pre>\n"
      ],
      "text/plain": [
       "\u001b[1mModel: \"functional\"\u001b[0m\n"
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    },
    {
     "data": {
      "text/html": [
       "<pre style=\"white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace\">┏━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━┓\n",
       "┃<span style=\"font-weight: bold\"> Layer (type)        </span>┃<span style=\"font-weight: bold\"> Output Shape      </span>┃<span style=\"font-weight: bold\">    Param # </span>┃<span style=\"font-weight: bold\"> Connected to      </span>┃\n",
       "┡━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━┩\n",
       "│ histone_input       │ (<span style=\"color: #00d7ff; text-decoration-color: #00d7ff\">None</span>, <span style=\"color: #00af00; text-decoration-color: #00af00\">100</span>, <span style=\"color: #00af00; text-decoration-color: #00af00\">5</span>)    │          <span style=\"color: #00af00; text-decoration-color: #00af00\">0</span> │ -                 │\n",
       "│ (<span style=\"color: #0087ff; text-decoration-color: #0087ff\">InputLayer</span>)        │                   │            │                   │\n",
       "├─────────────────────┼───────────────────┼────────────┼───────────────────┤\n",
       "│ conv1d (<span style=\"color: #0087ff; text-decoration-color: #0087ff\">Conv1D</span>)     │ (<span style=\"color: #00d7ff; text-decoration-color: #00d7ff\">None</span>, <span style=\"color: #00af00; text-decoration-color: #00af00\">100</span>, <span style=\"color: #00af00; text-decoration-color: #00af00\">32</span>)   │        <span style=\"color: #00af00; text-decoration-color: #00af00\">832</span> │ histone_input[<span style=\"color: #00af00; text-decoration-color: #00af00\">0</span>]… │\n",
       "├─────────────────────┼───────────────────┼────────────┼───────────────────┤\n",
       "│ conv1d_1 (<span style=\"color: #0087ff; text-decoration-color: #0087ff\">Conv1D</span>)   │ (<span style=\"color: #00d7ff; text-decoration-color: #00d7ff\">None</span>, <span style=\"color: #00af00; text-decoration-color: #00af00\">100</span>, <span style=\"color: #00af00; text-decoration-color: #00af00\">64</span>)   │     <span style=\"color: #00af00; text-decoration-color: #00af00\">10,304</span> │ conv1d[<span style=\"color: #00af00; text-decoration-color: #00af00\">0</span>][<span style=\"color: #00af00; text-decoration-color: #00af00\">0</span>]      │\n",
       "├─────────────────────┼───────────────────┼────────────┼───────────────────┤\n",
       "│ max_pooling1d       │ (<span style=\"color: #00d7ff; text-decoration-color: #00d7ff\">None</span>, <span style=\"color: #00af00; text-decoration-color: #00af00\">50</span>, <span style=\"color: #00af00; text-decoration-color: #00af00\">64</span>)    │          <span style=\"color: #00af00; text-decoration-color: #00af00\">0</span> │ conv1d_1[<span style=\"color: #00af00; text-decoration-color: #00af00\">0</span>][<span style=\"color: #00af00; text-decoration-color: #00af00\">0</span>]    │\n",
       "│ (<span style=\"color: #0087ff; text-decoration-color: #0087ff\">MaxPooling1D</span>)      │                   │            │                   │\n",
       "├─────────────────────┼───────────────────┼────────────┼───────────────────┤\n",
       "│ cell_id             │ (<span style=\"color: #00d7ff; text-decoration-color: #00d7ff\">None</span>, <span style=\"color: #00af00; text-decoration-color: #00af00\">1</span>)         │          <span style=\"color: #00af00; text-decoration-color: #00af00\">0</span> │ -                 │\n",
       "│ (<span style=\"color: #0087ff; text-decoration-color: #0087ff\">InputLayer</span>)        │                   │            │                   │\n",
       "├─────────────────────┼───────────────────┼────────────┼───────────────────┤\n",
       "│ conv1d_2 (<span style=\"color: #0087ff; text-decoration-color: #0087ff\">Conv1D</span>)   │ (<span style=\"color: #00d7ff; text-decoration-color: #00d7ff\">None</span>, <span style=\"color: #00af00; text-decoration-color: #00af00\">50</span>, <span style=\"color: #00af00; text-decoration-color: #00af00\">128</span>)   │     <span style=\"color: #00af00; text-decoration-color: #00af00\">57,472</span> │ max_pooling1d[<span style=\"color: #00af00; text-decoration-color: #00af00\">0</span>]… │\n",
       "├─────────────────────┼───────────────────┼────────────┼───────────────────┤\n",
       "│ cell_embedding      │ (<span style=\"color: #00d7ff; text-decoration-color: #00d7ff\">None</span>, <span style=\"color: #00af00; text-decoration-color: #00af00\">1</span>, <span style=\"color: #00af00; text-decoration-color: #00af00\">32</span>)     │      <span style=\"color: #00af00; text-decoration-color: #00af00\">1,792</span> │ cell_id[<span style=\"color: #00af00; text-decoration-color: #00af00\">0</span>][<span style=\"color: #00af00; text-decoration-color: #00af00\">0</span>]     │\n",
       "│ (<span style=\"color: #0087ff; text-decoration-color: #0087ff\">Embedding</span>)         │                   │            │                   │\n",
       "├─────────────────────┼───────────────────┼────────────┼───────────────────┤\n",
       "│ global_average_poo… │ (<span style=\"color: #00d7ff; text-decoration-color: #00d7ff\">None</span>, <span style=\"color: #00af00; text-decoration-color: #00af00\">128</span>)       │          <span style=\"color: #00af00; text-decoration-color: #00af00\">0</span> │ conv1d_2[<span style=\"color: #00af00; text-decoration-color: #00af00\">0</span>][<span style=\"color: #00af00; text-decoration-color: #00af00\">0</span>]    │\n",
       "│ (<span style=\"color: #0087ff; text-decoration-color: #0087ff\">GlobalAveragePool…</span> │                   │            │                   │\n",
       "├─────────────────────┼───────────────────┼────────────┼───────────────────┤\n",
       "│ flatten (<span style=\"color: #0087ff; text-decoration-color: #0087ff\">Flatten</span>)   │ (<span style=\"color: #00d7ff; text-decoration-color: #00d7ff\">None</span>, <span style=\"color: #00af00; text-decoration-color: #00af00\">32</span>)        │          <span style=\"color: #00af00; text-decoration-color: #00af00\">0</span> │ cell_embedding[<span style=\"color: #00af00; text-decoration-color: #00af00\">0</span>… │\n",
       "├─────────────────────┼───────────────────┼────────────┼───────────────────┤\n",
       "│ concatenate         │ (<span style=\"color: #00d7ff; text-decoration-color: #00d7ff\">None</span>, <span style=\"color: #00af00; text-decoration-color: #00af00\">160</span>)       │          <span style=\"color: #00af00; text-decoration-color: #00af00\">0</span> │ global_average_p… │\n",
       "│ (<span style=\"color: #0087ff; text-decoration-color: #0087ff\">Concatenate</span>)       │                   │            │ flatten[<span style=\"color: #00af00; text-decoration-color: #00af00\">0</span>][<span style=\"color: #00af00; text-decoration-color: #00af00\">0</span>]     │\n",
       "├─────────────────────┼───────────────────┼────────────┼───────────────────┤\n",
       "│ dense (<span style=\"color: #0087ff; text-decoration-color: #0087ff\">Dense</span>)       │ (<span style=\"color: #00d7ff; text-decoration-color: #00d7ff\">None</span>, <span style=\"color: #00af00; text-decoration-color: #00af00\">256</span>)       │     <span style=\"color: #00af00; text-decoration-color: #00af00\">41,216</span> │ concatenate[<span style=\"color: #00af00; text-decoration-color: #00af00\">0</span>][<span style=\"color: #00af00; text-decoration-color: #00af00\">0</span>] │\n",
       "├─────────────────────┼───────────────────┼────────────┼───────────────────┤\n",
       "│ dense_1 (<span style=\"color: #0087ff; text-decoration-color: #0087ff\">Dense</span>)     │ (<span style=\"color: #00d7ff; text-decoration-color: #00d7ff\">None</span>, <span style=\"color: #00af00; text-decoration-color: #00af00\">1</span>)         │        <span style=\"color: #00af00; text-decoration-color: #00af00\">257</span> │ dense[<span style=\"color: #00af00; text-decoration-color: #00af00\">0</span>][<span style=\"color: #00af00; text-decoration-color: #00af00\">0</span>]       │\n",
       "└─────────────────────┴───────────────────┴────────────┴───────────────────┘\n",
       "</pre>\n"
      ],
      "text/plain": [
       "┏━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━┓\n",
       "┃\u001b[1m \u001b[0m\u001b[1mLayer (type)       \u001b[0m\u001b[1m \u001b[0m┃\u001b[1m \u001b[0m\u001b[1mOutput Shape     \u001b[0m\u001b[1m \u001b[0m┃\u001b[1m \u001b[0m\u001b[1m   Param #\u001b[0m\u001b[1m \u001b[0m┃\u001b[1m \u001b[0m\u001b[1mConnected to     \u001b[0m\u001b[1m \u001b[0m┃\n",
       "┡━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━┩\n",
       "│ histone_input       │ (\u001b[38;5;45mNone\u001b[0m, \u001b[38;5;34m100\u001b[0m, \u001b[38;5;34m5\u001b[0m)    │          \u001b[38;5;34m0\u001b[0m │ -                 │\n",
       "│ (\u001b[38;5;33mInputLayer\u001b[0m)        │                   │            │                   │\n",
       "├─────────────────────┼───────────────────┼────────────┼───────────────────┤\n",
       "│ conv1d (\u001b[38;5;33mConv1D\u001b[0m)     │ (\u001b[38;5;45mNone\u001b[0m, \u001b[38;5;34m100\u001b[0m, \u001b[38;5;34m32\u001b[0m)   │        \u001b[38;5;34m832\u001b[0m │ histone_input[\u001b[38;5;34m0\u001b[0m]… │\n",
       "├─────────────────────┼───────────────────┼────────────┼───────────────────┤\n",
       "│ conv1d_1 (\u001b[38;5;33mConv1D\u001b[0m)   │ (\u001b[38;5;45mNone\u001b[0m, \u001b[38;5;34m100\u001b[0m, \u001b[38;5;34m64\u001b[0m)   │     \u001b[38;5;34m10,304\u001b[0m │ conv1d[\u001b[38;5;34m0\u001b[0m][\u001b[38;5;34m0\u001b[0m]      │\n",
       "├─────────────────────┼───────────────────┼────────────┼───────────────────┤\n",
       "│ max_pooling1d       │ (\u001b[38;5;45mNone\u001b[0m, \u001b[38;5;34m50\u001b[0m, \u001b[38;5;34m64\u001b[0m)    │          \u001b[38;5;34m0\u001b[0m │ conv1d_1[\u001b[38;5;34m0\u001b[0m][\u001b[38;5;34m0\u001b[0m]    │\n",
       "│ (\u001b[38;5;33mMaxPooling1D\u001b[0m)      │                   │            │                   │\n",
       "├─────────────────────┼───────────────────┼────────────┼───────────────────┤\n",
       "│ cell_id             │ (\u001b[38;5;45mNone\u001b[0m, \u001b[38;5;34m1\u001b[0m)         │          \u001b[38;5;34m0\u001b[0m │ -                 │\n",
       "│ (\u001b[38;5;33mInputLayer\u001b[0m)        │                   │            │                   │\n",
       "├─────────────────────┼───────────────────┼────────────┼───────────────────┤\n",
       "│ conv1d_2 (\u001b[38;5;33mConv1D\u001b[0m)   │ (\u001b[38;5;45mNone\u001b[0m, \u001b[38;5;34m50\u001b[0m, \u001b[38;5;34m128\u001b[0m)   │     \u001b[38;5;34m57,472\u001b[0m │ max_pooling1d[\u001b[38;5;34m0\u001b[0m]… │\n",
       "├─────────────────────┼───────────────────┼────────────┼───────────────────┤\n",
       "│ cell_embedding      │ (\u001b[38;5;45mNone\u001b[0m, \u001b[38;5;34m1\u001b[0m, \u001b[38;5;34m32\u001b[0m)     │      \u001b[38;5;34m1,792\u001b[0m │ cell_id[\u001b[38;5;34m0\u001b[0m][\u001b[38;5;34m0\u001b[0m]     │\n",
       "│ (\u001b[38;5;33mEmbedding\u001b[0m)         │                   │            │                   │\n",
       "├─────────────────────┼───────────────────┼────────────┼───────────────────┤\n",
       "│ global_average_poo… │ (\u001b[38;5;45mNone\u001b[0m, \u001b[38;5;34m128\u001b[0m)       │          \u001b[38;5;34m0\u001b[0m │ conv1d_2[\u001b[38;5;34m0\u001b[0m][\u001b[38;5;34m0\u001b[0m]    │\n",
       "│ (\u001b[38;5;33mGlobalAveragePool…\u001b[0m │                   │            │                   │\n",
       "├─────────────────────┼───────────────────┼────────────┼───────────────────┤\n",
       "│ flatten (\u001b[38;5;33mFlatten\u001b[0m)   │ (\u001b[38;5;45mNone\u001b[0m, \u001b[38;5;34m32\u001b[0m)        │          \u001b[38;5;34m0\u001b[0m │ cell_embedding[\u001b[38;5;34m0\u001b[0m… │\n",
       "├─────────────────────┼───────────────────┼────────────┼───────────────────┤\n",
       "│ concatenate         │ (\u001b[38;5;45mNone\u001b[0m, \u001b[38;5;34m160\u001b[0m)       │          \u001b[38;5;34m0\u001b[0m │ global_average_p… │\n",
       "│ (\u001b[38;5;33mConcatenate\u001b[0m)       │                   │            │ flatten[\u001b[38;5;34m0\u001b[0m][\u001b[38;5;34m0\u001b[0m]     │\n",
       "├─────────────────────┼───────────────────┼────────────┼───────────────────┤\n",
       "│ dense (\u001b[38;5;33mDense\u001b[0m)       │ (\u001b[38;5;45mNone\u001b[0m, \u001b[38;5;34m256\u001b[0m)       │     \u001b[38;5;34m41,216\u001b[0m │ concatenate[\u001b[38;5;34m0\u001b[0m][\u001b[38;5;34m0\u001b[0m] │\n",
       "├─────────────────────┼───────────────────┼────────────┼───────────────────┤\n",
       "│ dense_1 (\u001b[38;5;33mDense\u001b[0m)     │ (\u001b[38;5;45mNone\u001b[0m, \u001b[38;5;34m1\u001b[0m)         │        \u001b[38;5;34m257\u001b[0m │ dense[\u001b[38;5;34m0\u001b[0m][\u001b[38;5;34m0\u001b[0m]       │\n",
       "└─────────────────────┴───────────────────┴────────────┴───────────────────┘\n"
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    },
    {
     "data": {
      "text/html": [
       "<pre style=\"white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace\"><span style=\"font-weight: bold\"> Total params: </span><span style=\"color: #00af00; text-decoration-color: #00af00\">111,873</span> (437.00 KB)\n",
       "</pre>\n"
      ],
      "text/plain": [
       "\u001b[1m Total params: \u001b[0m\u001b[38;5;34m111,873\u001b[0m (437.00 KB)\n"
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    },
    {
     "data": {
      "text/html": [
       "<pre style=\"white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace\"><span style=\"font-weight: bold\"> Trainable params: </span><span style=\"color: #00af00; text-decoration-color: #00af00\">111,873</span> (437.00 KB)\n",
       "</pre>\n"
      ],
      "text/plain": [
       "\u001b[1m Trainable params: \u001b[0m\u001b[38;5;34m111,873\u001b[0m (437.00 KB)\n"
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    },
    {
     "data": {
      "text/html": [
       "<pre style=\"white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace\"><span style=\"font-weight: bold\"> Non-trainable params: </span><span style=\"color: #00af00; text-decoration-color: #00af00\">0</span> (0.00 B)\n",
       "</pre>\n"
      ],
      "text/plain": [
       "\u001b[1m Non-trainable params: \u001b[0m\u001b[38;5;34m0\u001b[0m (0.00 B)\n"
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    }
   ],
   "source": [
    "# Final model\n",
    "\n",
    "model = Model(\n",
    "    inputs=[signal_input, cell_input],\n",
    "    outputs=output\n",
    ")\n",
    "\n",
    "model.compile(\n",
    "    optimizer=tf.keras.optimizers.Adam(learning_rate=5e-4),\n",
    "    loss=\"mse\",\n",
    "    metrics=[\"mse\"]\n",
    ")\n",
    "\n",
    "model.summary()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 22,
   "id": "53554a94",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2026-01-13T11:19:55.205880Z",
     "iopub.status.busy": "2026-01-13T11:19:55.205390Z",
     "iopub.status.idle": "2026-01-13T11:19:55.208563Z",
     "shell.execute_reply": "2026-01-13T11:19:55.207969Z"
    },
    "papermill": {
     "duration": 0.010307,
     "end_time": "2026-01-13T11:19:55.209853",
     "exception": false,
     "start_time": "2026-01-13T11:19:55.199546",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [],
   "source": [
    "early_stop = EarlyStopping(\n",
    "    monitor='val_loss',\n",
    "    patience=3,   \n",
    "    restore_best_weights=True\n",
    ")\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 23,
   "id": "57f03fc4",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2026-01-13T11:19:55.220436Z",
     "iopub.status.busy": "2026-01-13T11:19:55.220213Z",
     "iopub.status.idle": "2026-01-13T11:26:10.507404Z",
     "shell.execute_reply": "2026-01-13T11:26:10.506573Z"
    },
    "papermill": {
     "duration": 375.422346,
     "end_time": "2026-01-13T11:26:10.636895",
     "exception": false,
     "start_time": "2026-01-13T11:19:55.214549",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Epoch 1/30\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "WARNING: All log messages before absl::InitializeLog() is called are written to STDERR\n",
      "I0000 00:00:1768303199.506689      68 service.cc:152] XLA service 0x7ed16400c500 initialized for platform CUDA (this does not guarantee that XLA will be used). Devices:\n",
      "I0000 00:00:1768303199.506720      68 service.cc:160]   StreamExecutor device (0): Tesla T4, Compute Capability 7.5\n",
      "I0000 00:00:1768303199.506727      68 service.cc:160]   StreamExecutor device (1): Tesla T4, Compute Capability 7.5\n",
      "I0000 00:00:1768303199.838955      68 cuda_dnn.cc:529] Loaded cuDNN version 91002\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "\u001b[1m   58/10000\u001b[0m \u001b[37m━━━━━━━━━━━━━━━━━━━━\u001b[0m \u001b[1m27s\u001b[0m 3ms/step - loss: 1.0261 - mse: 1.0261"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "I0000 00:00:1768303201.979797      68 device_compiler.h:188] Compiled cluster using XLA!  This line is logged at most once for the lifetime of the process.\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "\u001b[1m10000/10000\u001b[0m \u001b[32m━━━━━━━━━━━━━━━━━━━━\u001b[0m\u001b[37m\u001b[0m \u001b[1m38s\u001b[0m 3ms/step - loss: 0.9345 - mse: 0.9345 - val_loss: 0.8984 - val_mse: 0.8984\n",
      "Epoch 2/30\n",
      "\u001b[1m10000/10000\u001b[0m \u001b[32m━━━━━━━━━━━━━━━━━━━━\u001b[0m\u001b[37m\u001b[0m \u001b[1m34s\u001b[0m 3ms/step - loss: 0.8915 - mse: 0.8915 - val_loss: 0.8807 - val_mse: 0.8807\n",
      "Epoch 3/30\n",
      "\u001b[1m10000/10000\u001b[0m \u001b[32m━━━━━━━━━━━━━━━━━━━━\u001b[0m\u001b[37m\u001b[0m \u001b[1m33s\u001b[0m 3ms/step - loss: 0.8777 - mse: 0.8777 - val_loss: 0.8749 - val_mse: 0.8749\n",
      "Epoch 4/30\n",
      "\u001b[1m10000/10000\u001b[0m \u001b[32m━━━━━━━━━━━━━━━━━━━━\u001b[0m\u001b[37m\u001b[0m \u001b[1m33s\u001b[0m 3ms/step - loss: 0.8681 - mse: 0.8681 - val_loss: 0.8692 - val_mse: 0.8692\n",
      "Epoch 5/30\n",
      "\u001b[1m10000/10000\u001b[0m \u001b[32m━━━━━━━━━━━━━━━━━━━━\u001b[0m\u001b[37m\u001b[0m \u001b[1m33s\u001b[0m 3ms/step - loss: 0.8602 - mse: 0.8602 - val_loss: 0.8660 - val_mse: 0.8660\n",
      "Epoch 6/30\n",
      "\u001b[1m10000/10000\u001b[0m \u001b[32m━━━━━━━━━━━━━━━━━━━━\u001b[0m\u001b[37m\u001b[0m \u001b[1m33s\u001b[0m 3ms/step - loss: 0.8533 - mse: 0.8533 - val_loss: 0.8639 - val_mse: 0.8639\n",
      "Epoch 7/30\n",
      "\u001b[1m10000/10000\u001b[0m \u001b[32m━━━━━━━━━━━━━━━━━━━━\u001b[0m\u001b[37m\u001b[0m \u001b[1m33s\u001b[0m 3ms/step - loss: 0.8467 - mse: 0.8467 - val_loss: 0.8628 - val_mse: 0.8628\n",
      "Epoch 8/30\n",
      "\u001b[1m10000/10000\u001b[0m \u001b[32m━━━━━━━━━━━━━━━━━━━━\u001b[0m\u001b[37m\u001b[0m \u001b[1m33s\u001b[0m 3ms/step - loss: 0.8404 - mse: 0.8404 - val_loss: 0.8621 - val_mse: 0.8621\n",
      "Epoch 9/30\n",
      "\u001b[1m10000/10000\u001b[0m \u001b[32m━━━━━━━━━━━━━━━━━━━━\u001b[0m\u001b[37m\u001b[0m \u001b[1m33s\u001b[0m 3ms/step - loss: 0.8340 - mse: 0.8340 - val_loss: 0.8639 - val_mse: 0.8639\n",
      "Epoch 10/30\n",
      "\u001b[1m10000/10000\u001b[0m \u001b[32m━━━━━━━━━━━━━━━━━━━━\u001b[0m\u001b[37m\u001b[0m \u001b[1m33s\u001b[0m 3ms/step - loss: 0.8276 - mse: 0.8276 - val_loss: 0.8639 - val_mse: 0.8639\n",
      "Epoch 11/30\n",
      "\u001b[1m10000/10000\u001b[0m \u001b[32m━━━━━━━━━━━━━━━━━━━━\u001b[0m\u001b[37m\u001b[0m \u001b[1m34s\u001b[0m 3ms/step - loss: 0.8212 - mse: 0.8212 - val_loss: 0.8655 - val_mse: 0.8655\n"
     ]
    }
   ],
   "source": [
    "#train \n",
    "\n",
    "history = model.fit(\n",
    "    [X_train, cell_train],y_train,\n",
    "    validation_data=([X_val, cell_val], y_val),\n",
    "    epochs=30,\n",
    "    batch_size=64,\n",
    "    callbacks=[early_stop],\n",
    "    verbose=1\n",
    ")"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "2576b742",
   "metadata": {
    "papermill": {
     "duration": 0.232133,
     "end_time": "2026-01-13T11:26:11.101725",
     "exception": false,
     "start_time": "2026-01-13T11:26:10.869592",
     "status": "completed"
    },
    "tags": []
   },
   "source": [
    "# Model Evaluation "
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 24,
   "id": "766ed049",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2026-01-13T11:26:11.641516Z",
     "iopub.status.busy": "2026-01-13T11:26:11.641242Z",
     "iopub.status.idle": "2026-01-13T11:26:22.508120Z",
     "shell.execute_reply": "2026-01-13T11:26:22.507198Z"
    },
    "papermill": {
     "duration": 11.176415,
     "end_time": "2026-01-13T11:26:22.509583",
     "exception": false,
     "start_time": "2026-01-13T11:26:11.333168",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "\u001b[1m5000/5000\u001b[0m \u001b[32m━━━━━━━━━━━━━━━━━━━━\u001b[0m\u001b[37m\u001b[0m \u001b[1m8s\u001b[0m 1ms/step\n",
      "MSE: 3.005\n",
      "R²: 0.138\n"
     ]
    }
   ],
   "source": [
    "y_val_pred_scaled = model.predict([X_val, cell_val]).flatten()\n",
    "\n",
    "y_val_pred = scaler.inverse_transform(\n",
    "    y_val_pred_scaled.reshape(-1,1)\n",
    ").flatten()\n",
    "\n",
    "y_val_true = scaler.inverse_transform(\n",
    "    y_val.reshape(-1,1)\n",
    ").flatten()\n",
    "\n",
    "mse = mean_squared_error(y_val_true, y_val_pred)\n",
    "r2 = r2_score(y_val_true, y_val_pred)\n",
    "\n",
    "print(f\"MSE: {mse:.3f}\")\n",
    "print(f\"R²: {r2:.3f}\")"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "5be1f1eb",
   "metadata": {
    "papermill": {
     "duration": 0.234192,
     "end_time": "2026-01-13T11:26:22.979253",
     "exception": false,
     "start_time": "2026-01-13T11:26:22.745061",
     "status": "completed"
    },
    "tags": []
   },
   "source": [
    "# Prediction and Submission "
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 25,
   "id": "ab2b9b43",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2026-01-13T11:26:23.450130Z",
     "iopub.status.busy": "2026-01-13T11:26:23.449616Z",
     "iopub.status.idle": "2026-01-13T11:26:35.493894Z",
     "shell.execute_reply": "2026-01-13T11:26:35.493276Z"
    },
    "papermill": {
     "duration": 12.284425,
     "end_time": "2026-01-13T11:26:35.495678",
     "exception": false,
     "start_time": "2026-01-13T11:26:23.211253",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "\u001b[1m5533/5533\u001b[0m \u001b[32m━━━━━━━━━━━━━━━━━━━━\u001b[0m\u001b[37m\u001b[0m \u001b[1m8s\u001b[0m 1ms/step\n"
     ]
    }
   ],
   "source": [
    "eval_preds_scaled = model.predict([eval_X, eval_cell_ids]).flatten()\n",
    "eval_preds = scaler.inverse_transform(\n",
    "    eval_preds_scaled.reshape(-1,1)\n",
    ").flatten()\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 26,
   "id": "43d453e0",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2026-01-13T11:26:35.975427Z",
     "iopub.status.busy": "2026-01-13T11:26:35.975112Z",
     "iopub.status.idle": "2026-01-13T11:26:36.263520Z",
     "shell.execute_reply": "2026-01-13T11:26:36.262821Z"
    },
    "papermill": {
     "duration": 0.530519,
     "end_time": "2026-01-13T11:26:36.265058",
     "exception": false,
     "start_time": "2026-01-13T11:26:35.734539",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>id</th>\n",
       "      <th>expression</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>0</th>\n",
       "      <td>E065_115459</td>\n",
       "      <td>-0.631478</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1</th>\n",
       "      <td>E065_162723</td>\n",
       "      <td>-0.133107</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2</th>\n",
       "      <td>E065_196275</td>\n",
       "      <td>-0.751215</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>3</th>\n",
       "      <td>E065_232774</td>\n",
       "      <td>0.352584</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>4</th>\n",
       "      <td>E065_172339</td>\n",
       "      <td>-0.506806</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "</div>"
      ],
      "text/plain": [
       "            id  expression\n",
       "0  E065_115459   -0.631478\n",
       "1  E065_162723   -0.133107\n",
       "2  E065_196275   -0.751215\n",
       "3  E065_232774    0.352584\n",
       "4  E065_172339   -0.506806"
      ]
     },
     "execution_count": 26,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "submission = pd.DataFrame({\n",
    "    \"id\": eval_ids,\n",
    "    \"expression\": eval_preds\n",
    "})\n",
    "\n",
    "submission.to_csv(\"submission.csv\", index=False)\n",
    "submission.head()\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "ebeaa4d0",
   "metadata": {
    "papermill": {
     "duration": 0.314649,
     "end_time": "2026-01-13T11:26:36.820999",
     "exception": false,
     "start_time": "2026-01-13T11:26:36.506350",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [],
   "source": []
  }
 ],
 "metadata": {
  "kaggle": {
   "accelerator": "nvidiaTeslaT4",
   "dataSources": [
    {
     "databundleVersionId": 1117628,
     "sourceId": 20182,
     "sourceType": "competition"
    }
   ],
   "dockerImageVersionId": 31236,
   "isGpuEnabled": true,
   "isInternetEnabled": true,
   "language": "python",
   "sourceType": "notebook"
  },
  "kernelspec": {
   "display_name": "Python 3",
   "language": "python",
   "name": "python3"
  },
  "language_info": {
   "codemirror_mode": {
    "name": "ipython",
    "version": 3
   },
   "file_extension": ".py",
   "mimetype": "text/x-python",
   "name": "python",
   "nbconvert_exporter": "python",
   "pygments_lexer": "ipython3",
   "version": "3.12.12"
  },
  "papermill": {
   "default_parameters": {},
   "duration": 438.181733,
   "end_time": "2026-01-13T11:26:40.700007",
   "environment_variables": {},
   "exception": null,
   "input_path": "__notebook__.ipynb",
   "output_path": "__notebook__.ipynb",
   "parameters": {},
   "start_time": "2026-01-13T11:19:22.518274",
   "version": "2.6.0"
  }
 },
 "nbformat": 4,
 "nbformat_minor": 5
}
